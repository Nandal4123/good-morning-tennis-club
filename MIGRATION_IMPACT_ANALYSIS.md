# ⚠️ 마이그레이션 영향도 분석

현재 운영 중인 앱에 미치는 영향을 분석합니다.

---

## 📊 영향도 평가

### ✅ 안전한 부분 (영향 없음)

#### 1. 코드 변경
- **현재 상태**: `MULTI_TENANT_MODE=false` (기본값)
- **동작**: 멀티 테넌트 로직이 비활성화됨
- **결과**: 기존 코드와 동일하게 작동

#### 2. 데이터베이스 스키마
- **변경 사항**: 
  - Club 테이블 생성 (새 테이블, 기존 데이터 영향 없음)
  - clubId 컬럼 추가 (NULL 허용, 기존 데이터는 NULL로 유지)
- **기존 데이터**: 모두 그대로 유지됨
- **결과**: 기존 기능에 영향 없음

#### 3. API 동작
- **현재**: `getClubFilter(req)` → `null` 반환
- **결과**: 클럽 필터가 적용되지 않음 (기존과 동일)
- **모든 쿼리**: `where: {}` 또는 `where: { id }` (기존과 동일)

---

## ⚠️ 주의할 부분 (잠재적 영향)

### 1. 데이터베이스 스키마 변경
**영향:**
- `prisma db push` 실행 시 데이터베이스 스키마 변경
- Supabase Transaction Mode의 연결 제한 문제 가능성

**완화 방법:**
- 이미 `connection_limit=1` 설정되어 있음
- 스키마 변경은 빠르게 완료됨 (수초)

**예상 다운타임:**
- 5-10초 (스키마 변경 시간)

---

### 2. Prisma Client 재생성
**영향:**
- 서버 재시작 필요
- 재시작 중 일시적 다운타임

**완화 방법:**
- 서버 재시작은 빠름 (1-2초)
- 또는 무중단 배포 가능

---

### 3. 데이터 마이그레이션 스크립트
**영향:**
- 모든 데이터에 clubId 할당
- 대량 업데이트 작업

**완화 방법:**
- 스크립트가 안전하게 작성됨
- 기존 데이터는 변경되지 않음 (clubId만 추가)
- 실패 시 롤백 가능

---

## 🎯 실제 영향도

### 시나리오 1: 스키마만 적용 (prisma db push)

**영향:**
- ✅ 기존 기능: 정상 작동
- ✅ 기존 데이터: 그대로 유지
- ⚠️ 다운타임: 5-10초 (스키마 변경 중)
- ⚠️ 서버 재시작: 필요 (1-2초)

**총 다운타임: 약 10-15초**

---

### 시나리오 2: 스키마 + 데이터 마이그레이션

**영향:**
- ✅ 기존 기능: 정상 작동
- ✅ 기존 데이터: 그대로 유지 (clubId만 추가)
- ⚠️ 다운타임: 10-30초 (스키마 변경 + 데이터 업데이트)
- ⚠️ 서버 재시작: 필요 (1-2초)

**총 다운타임: 약 15-35초**

---

## ✅ 안전 장치

### 1. 환경 변수 제어
```env
MULTI_TENANT_MODE=false  # 멀티 테넌트 비활성화
```

**결과:**
- 모든 멀티 테넌트 로직이 비활성화됨
- 기존 코드와 동일하게 작동

---

### 2. 옵셔널 필드
```prisma
clubId String?  // NULL 허용
```

**결과:**
- 기존 데이터는 clubId가 NULL
- NULL인 경우 필터가 적용되지 않음
- 기존 동작과 동일

---

### 3. 하위 호환성
```javascript
// 멀티 테넌트 모드가 아니면
if (!isMultiTenantMode()) {
  return null;  // 필터 없음
}
```

**결과:**
- MVP 모드에서는 클럽 필터가 적용되지 않음
- 기존 동작과 동일

---

## 📋 안전한 마이그레이션 절차

### Phase 1: 스키마만 적용 (최소 영향)
```bash
# 1. Prisma Client 재생성 (이미 완료)
pnpm run db:generate

# 2. 스키마 적용
pnpm run db:push
```

**영향:**
- 다운타임: 5-10초
- 기존 기능: 정상 작동
- 기존 데이터: 그대로 유지

---

### Phase 2: 데이터 마이그레이션 (나중에)
```bash
# 기본 클럽 생성 및 데이터 할당
node scripts/create-default-club.js
```

**영향:**
- 다운타임: 없음 (백그라운드 작업)
- 기존 기능: 정상 작동
- 기존 데이터: clubId만 추가됨

---

## 🎯 결론

### 현재 운영 앱에 미치는 영향

**코드 변경:**
- ✅ **영향 없음** (멀티 테넌트 모드 비활성화)

**데이터베이스 스키마:**
- ⚠️ **최소 영향** (5-10초 다운타임)
- ✅ 기존 데이터는 그대로 유지
- ✅ 기존 기능은 정상 작동

**데이터 마이그레이션:**
- ✅ **영향 없음** (백그라운드 작업)
- ✅ 기존 데이터는 변경되지 않음 (clubId만 추가)

---

## 💡 추천 방법

### 방법 1: 단계별 적용 (가장 안전)

**Step 1: 스키마만 적용**
```bash
pnpm run db:push
```
- 다운타임: 5-10초
- 기존 기능: 정상 작동
- 멀티 테넌트는 아직 비활성화

**Step 2: 데이터 마이그레이션 (나중에)**
```bash
node scripts/create-default-club.js
```
- 다운타임: 없음
- 기존 기능: 정상 작동

**Step 3: 멀티 테넌트 활성화 (준비 완료 후)**
```env
MULTI_TENANT_MODE=true
```

---

### 방법 2: 한 번에 적용

**모든 작업을 한 번에:**
```bash
pnpm run db:push
node scripts/create-default-club.js
```

**영향:**
- 다운타임: 15-35초
- 기존 기능: 정상 작동

---

## ⚠️ 주의사항

### 1. 백업 필수
```bash
pnpm run db:backup
```

### 2. 서버 재시작 필요
- `prisma db push` 후 서버 재시작 필요
- 또는 무중단 배포

### 3. 테스트 권장
- 스테이징 환경에서 먼저 테스트
- 또는 로컬에서 테스트

---

## 🎯 최종 답변

### 현재 운영 앱에 영향을 주나요?

**답변: 최소한의 영향만 있습니다.**

1. **코드 동작**: 영향 없음 (멀티 테넌트 모드 비활성화)
2. **데이터**: 영향 없음 (기존 데이터 그대로 유지)
3. **다운타임**: 5-10초 (스키마 변경 시간)
4. **기능**: 정상 작동 (기존과 동일)

**안전 장치:**
- ✅ 멀티 테넌트 모드 비활성화
- ✅ clubId는 옵셔널 (NULL 허용)
- ✅ 하위 호환성 유지

**결론: 안전하게 적용 가능합니다!** ✅

---

## 📝 추천 절차

1. **백업** (필수)
   ```bash
   pnpm run db:backup
   ```

2. **스키마 적용** (5-10초 다운타임)
   ```bash
   pnpm run db:push
   ```

3. **서버 재시작** (1-2초 다운타임)
   ```bash
   # 서버 재시작
   ```

4. **검증** (기존 기능 테스트)

5. **데이터 마이그레이션** (나중에, 다운타임 없음)
   ```bash
   node scripts/create-default-club.js
   ```

**총 다운타임: 약 10-15초**

---

**준비되면 진행하시겠습니까?** 🚀

