# 중복 출석 데이터 정리 가이드

## 📋 문제 상황

경기 등록 시 자동 출석 기능으로 인해 같은 사용자가 같은 날짜에 여러 출석 기록이 생성될 수 있습니다.

**예시:**
- 사용자 A가 2025-12-15에 경기 1 등록 → 출석 생성
- 사용자 A가 2025-12-15에 경기 2 등록 → 중복 출석 생성 ❌

## ✅ 해결 방법

### 1. 자동 중복 방지 (이미 적용됨)

새로운 경기 등록 시:
- 해당 날짜에 이미 출석이 있는지 확인
- 있으면 새로 생성하지 않음
- **하루에 한 번만 출석 기록**

### 2. 기존 중복 데이터 정리

이미 중복으로 기록된 출석 데이터를 정리하는 스크립트를 실행합니다.

## 🔧 중복 출석 정리 스크립트 실행

### 실행 방법

```bash
cd server
pnpm run db:cleanup-duplicates
```

또는 직접 실행:

```bash
cd server
node scripts/cleanup-duplicate-attendances.js
```

### 스크립트 동작 방식

1. **중복 검색**
   - 모든 출석 데이터를 가져옴
   - 사용자별, 날짜별로 그룹핑
   - 같은 사용자가 같은 날짜에 여러 출석이 있는 경우 찾기

2. **정리 규칙**
   - 같은 날짜에 여러 출석이 있으면:
     - **가장 이른 세션의 출석만 유지**
     - 나머지 출석은 삭제
   - 세션 날짜가 같으면 `createdAt`이 가장 이른 것을 유지

3. **결과 출력**
   - 중복 그룹 수
   - 유지된 출석
   - 삭제된 출석 목록

### 실행 예시

```bash
$ pnpm run db:cleanup-duplicates

🔍 중복 출석 데이터 검색 중...
📊 총 출석 기록 수: 150
⚠️  중복 출석 그룹 수: 5

👤 사용자: 홍길동 (user123)
📅 날짜: 2025-12-15
✅ 유지할 출석: att001 (세션: sess001, 날짜: 2025-12-15T03:00:00.000Z)
❌ 삭제할 출석: 2개
   - 삭제: att002 (세션: sess002)
   - 삭제: att003 (세션: sess003)

📊 정리 결과:
✅ 유지된 그룹: 5개
❌ 삭제된 출석: 8개
✅ 중복 출석 정리 완료!
```

## ⚠️ 주의사항

1. **백업 권장**
   - 스크립트 실행 전 데이터베이스 백업 권장
   ```bash
   pnpm run db:backup
   ```

2. **실행 전 확인**
   - 스크립트는 실제로 데이터를 삭제합니다
   - 실행 전에 중복 데이터가 있는지 확인하세요

3. **안전한 실행**
   - 스크립트는 가장 이른 세션의 출석만 유지합니다
   - 삭제 전에 어떤 출석이 유지/삭제되는지 출력합니다

## 🔍 중복 출석 확인 방법

### 수동 확인 (Prisma Studio)

```bash
cd server
pnpm run db:studio
```

1. `Attendance` 테이블 열기
2. `userId`와 `date` 기준으로 정렬
3. 같은 `userId`와 같은 날짜에 여러 레코드가 있는지 확인

### SQL 쿼리로 확인

```sql
SELECT 
  userId,
  DATE(date) as attendance_date,
  COUNT(*) as count
FROM attendances
GROUP BY userId, DATE(date)
HAVING COUNT(*) > 1;
```

## 📝 요약

1. **새로운 경기 등록**: 자동으로 중복 방지 (이미 적용됨)
2. **기존 중복 데이터**: 스크립트로 정리
3. **실행 명령어**: `pnpm run db:cleanup-duplicates`
4. **안전성**: 백업 후 실행 권장

## 🎯 다음 단계

1. 데이터베이스 백업
2. 중복 출석 정리 스크립트 실행
3. 결과 확인
4. 필요시 추가 정리

